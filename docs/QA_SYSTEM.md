# Q&A System - Documentation

## ðŸŽ¯ Overview

The Q&A system is a new feature that allows you to ask questions and get direct answers from your knowledge base (articles and PDFs) using RAG (Retrieval-Augmented Generation).

### Difference from Classification

| Feature | `/classify` Endpoint | `/ask` Endpoint |
|---------|---------------------|-----------------|
| **Purpose** | Categorize support tickets | Answer questions directly |
| **Input** | Support text/complaint | Question |
| **Output** | Category, issue type, routing | Direct answer with sources |
| **Use Case** | Ticket routing, analytics | Customer self-service, chatbot |
| **Response** | Structured JSON (category, etc.) | Natural language answer |

## ðŸš€ Quick Start

### 1. Test Locally

```bash
# Test Q&A system
python3 test_qa.py
```

### 2. Use API

```bash
# Start server
python3 server.py

# Ask a question
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{"question": "How do I reset my password?"}'
```

## ðŸ“Š API Endpoint

### POST `/ask`

Answer customer questions using RAG-retrieved context.

**Request Body:**

```json
{
  "question": "How do I reset my password?",
  "language": "en",     // Optional: en, ar, ku
  "app_name": "ana"     // Optional: Filter by app
}
```

**Response:**

```json
{
  "answer": "To reset your password in the ana app:\n\n1. Open the app's main interface\n2. At the top of the screen, tap the options button\n3. Select 'Change Password' from the menu\n4. Enter a new password (can include numbers and letters)\n5. Tap 'Confirm' to save\n\nYour password will be updated immediately.",
  "sources": [
    {
      "type": "article",
      "article_id": "17",
      "title": "reset password",
      "app": "ana",
      "similarity": 0.923
    },
    {
      "type": "article",
      "article_id": "16",
      "title": "Reset Password",
      "app": "self-care",
      "similarity": 0.856
    }
  ],
  "confidence": "high",
  "retrieved_docs": 3
}
```

## ðŸŽ“ Usage Examples

### Example 1: Basic Question

```bash
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{
    "question": "How do I reset my password?"
  }'
```

### Example 2: Arabic Question

```bash
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{
    "question": "ÙƒÙŠÙ Ø£Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ",
    "language": "ar"
  }'
```

### Example 3: App-Specific Question

```bash
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{
    "question": "How do I send points?",
    "app_name": "self-care"
  }'
```

### Example 4: Python Client

```python
from src.api.qa import answer_question

# Ask a question
result = answer_question(
    question="What is HD Call?",
    language="en"
)

print(f"Answer: {result['answer']}")
print(f"Confidence: {result['confidence']}")
print(f"Sources: {len(result['sources'])}")
```

## ðŸ“ Response Fields

### `answer` (string)

The direct answer to the question, generated by the AI using retrieved context.

### `sources` (array)

List of source documents used to generate the answer:

- **type**: "article" or "pdf"
- **article_id**: Article ID (for articles)
- **title**: Article title (for articles)
- **app**: App name (for articles)
- **file**: PDF filename (for PDFs)
- **similarity**: Similarity score (0-1)

### `confidence` (string)

Confidence level based on similarity scores:

- **high**: Average similarity > 0.8
- **medium**: Average similarity > 0.6
- **low**: Average similarity â‰¤ 0.6

### `retrieved_docs` (integer)

Number of documents retrieved from the knowledge base.

## ðŸ”§ Configuration

### Adjust Retrieval Settings

Edit `src/rag/retriever.py`:

```python
RAGRetriever(
    n_results=3,              # Number of documents to retrieve
    similarity_threshold=0.5   # Minimum similarity score
)
```

### Adjust Answer Generation

Edit `src/api/qa.py`:

```python
ollama.generate(
    model=model_name,
    system=system_prompt,
    prompt=question,
    options={
        "temperature": 0.3,    # Creativity (0.0-1.0)
        "top_p": 0.9,          # Sampling threshold
        "num_predict": 500,    # Max response length
    }
)
```

### Customize Q&A Prompt

Edit the `get_qa_prompt()` function in `src/api/qa.py` to customize how the AI answers questions.

## ðŸŽ¯ Use Cases

### 1. Customer Self-Service Portal

```javascript
// Frontend example
async function askQuestion(question) {
  const response = await fetch('http://localhost:8001/ask', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question })
  });
  
  const data = await response.json();
  
  // Display answer
  document.getElementById('answer').textContent = data.answer;
  
  // Show sources
  data.sources.forEach(source => {
    console.log(`Source: Article #${source.article_id} - ${source.title}`);
  });
}
```

### 2. Chatbot Integration

```python
from src.api.qa import answer_question

def chatbot_response(user_message):
    """Generate chatbot response."""
    result = answer_question(user_message)
    
    if result['confidence'] == 'high':
        return result['answer']
    else:
        return (
            result['answer'] + 
            "\n\nWould you like to speak with a human agent?"
        )
```

### 3. FAQ System

```python
# Pre-generate answers for common questions
common_questions = [
    "How do I reset my password?",
    "How do I download the app?",
    "What should I do if internet is slow?"
]

faq_cache = {}
for question in common_questions:
    result = answer_question(question)
    faq_cache[question] = result['answer']
```

## ðŸ“Š Performance

| Metric | Value |
|--------|-------|
| Average Response Time | 1-3 seconds |
| Retrieval Time | 100-300ms |
| Answer Generation | 500-2000ms |
| Accuracy | High (with good knowledge base) |

## ðŸ” Troubleshooting

### Issue: "I don't have enough information"

**Cause**: No relevant documents found in knowledge base.

**Solutions:**

1. Lower similarity threshold in `src/rag/retriever.py`
2. Add more articles to knowledge base
3. Rephrase the question
4. Check if knowledge base is indexed

### Issue: Answers are too generic

**Cause**: Retrieved context not specific enough.

**Solutions:**

1. Increase `n_results` to retrieve more documents
2. Use `app_name` filter to narrow search
3. Improve article content quality
4. Adjust temperature in `qa.py` (lower = more focused)

### Issue: Slow response times

**Solutions:**

1. Reduce `n_results` from 3 to 2
2. Reduce `num_predict` from 500 to 300
3. Use a faster embedding model
4. Implement caching for common questions

### Issue: Wrong language in response

**Cause**: Model not matching question language.

**Solutions:**

1. Explicitly set `language` parameter
2. Update Q&A prompt to emphasize language matching
3. Filter retrieval by language

## ðŸ§ª Testing

### Run Test Suite

```bash
python3 test_qa.py
```

### Manual Testing

```bash
# Start server
python3 server.py

# Test in another terminal
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{"question": "YOUR_QUESTION_HERE"}'
```

### Test Different Languages

```bash
# English
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{"question": "How to reset password?"}'

# Arabic
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{"question": "ÙƒÙŠÙ Ø£Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ"}'

# Kurdish
curl -X POST http://localhost:8001/ask \
  -H 'Content-Type: application/json' \
  -d '{"question": "Ã‡awa ÅŸÃ®freyÃª ji nÃ» ve saz bikim?"}'
```

## ðŸ“š API Documentation

Access interactive API documentation:

```bash
# Start server
python3 server.py

# Open in browser
http://localhost:8001/docs
```

This provides:

- Interactive API testing
- Request/response examples
- Schema documentation
- Try-it-out functionality

## ðŸŽ¨ Integration Examples

### React Frontend

```jsx
import React, { useState } from 'react';

function QAWidget() {
  const [question, setQuestion] = useState('');
  const [answer, setAnswer] = useState(null);
  const [loading, setLoading] = useState(false);

  const askQuestion = async () => {
    setLoading(true);
    const response = await fetch('http://localhost:8001/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });
    const data = await response.json();
    setAnswer(data);
    setLoading(false);
  };

  return (
    <div>
      <input 
        value={question}
        onChange={(e) => setQuestion(e.target.value)}
        placeholder="Ask a question..."
      />
      <button onClick={askQuestion} disabled={loading}>
        {loading ? 'Thinking...' : 'Ask'}
      </button>
      
      {answer && (
        <div>
          <p>{answer.answer}</p>
          <small>Confidence: {answer.confidence}</small>
        </div>
      )}
    </div>
  );
}
```

### WhatsApp Bot

```python
from twilio.rest import Client
from src.api.qa import answer_question

def handle_whatsapp_message(message):
    """Handle incoming WhatsApp message."""
    result = answer_question(message)
    
    # Send response
    client = Client(account_sid, auth_token)
    client.messages.create(
        body=result['answer'],
        from_='whatsapp:+14155238886',
        to=user_number
    )
```

## âœ… Summary

The Q&A system provides:

- âœ… Direct answers to customer questions
- âœ… Source attribution and confidence scores
- âœ… Multilingual support (EN, AR, KU)
- âœ… App-specific filtering
- âœ… RESTful API endpoint
- âœ… Easy integration with frontends

**Ready to use!** Start the server and try the `/ask` endpoint.
